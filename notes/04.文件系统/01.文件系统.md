# 1. 文件系统特性
##### 为什么磁盘分区完毕后要格式化？
因为每种操作系统所设置的文件属性/权限并不相同，而格式化就是为磁盘分区创建一套操作系统可以利用的**文件系统格式(filesystem)**，所以需要将分区格式化。

### 1. 文件系统
一个文件系统大致会包含三种区块：superblock, inode, block
##### 1. superblock
> 记录当前filesystem的整体信息。
> 包括：inode/block的总量、使用量、剩余量，文件系统的格式与相关信息等。

##### 2. inode
> 记录文件的属性、权限，一个文件占用一个inode，同时记录此文件的数据所在的block号码。

##### 3. block
> 记录文件的实际内容。文件太大时会占用多个block。

# 2. 文件系统类型
### 1. FAT
> U盘系统，闪存。没有inode存在，文件的所有block以链表形式存储。

![[../img/FAT文件系统数据存取示意图.png]]

### 2. 索引式文件系统 indexed allocation
> 每个文件占用一个inode。
> inode内有文件数据放置block号码。
> inode与block的大小在格式化的时候就定下来了，想要改动可以重新格式化或resize2fs指令。

![[../img/索引式文件系统.png]]

##### 1. Linux的EXT2文件系统 inode
- Ext2文件系统在格式化的时候会分为多个区块群组(block group)，每个区块群组都有独立的inode/block/superblock系统。
- 文件系统最前端有个开机扇区(boot sector)，这个扇区可以安装开机管理程序，每个文件系统最前端的开机扇区都可以安装不同的开机管理程序，这样就不用每个系统都覆盖掉整个磁盘唯一的MBR，这样多个系统就可以安装在同一块磁盘上了。

![[Ext2文件系统.png]]

###### 1. superblock 超级区块
> 记录整个filesystem相关信息的地方，一般大小为1024 Bytes：
> 	- block与inode的总量
> 	- 未使用/已使用block/inode数量
> 	- 单个block与inode的大小（block为1/2/4K，inode为128Bytes或256Bytes）
> 	- filesystem的挂载时间、最近一次写入数据的时间、最近一次检验磁盘(fsck)的时间 等文件系统相关信息
> 	- valid bit，若此文件系统已被挂载，valid bit = 0；若未被挂载，valid bit = 1。

###### 2. filesystem description 文件系统描述说明
> - 描述每个block group的开始与结束的block号码
> - 说明每个区段(superblock/bitmap/inodemap/data block)分别介于哪一个block号码之间。

###### 3. block bitmap 区块对照表
> 记录已被使用/未被使用的block号码。

###### 4. inode bitmap inode对照表
> 记录已使用/未使用的inode号码。

###### 5. dumpe2fs 查询Ext类文件系统superblock信息的指令
```shell
dumpe2fs [-bh] 设备文件名 # e.g. dumpe2fs /dev/vda1
```

### 3. 日志式文件系统 journaling filesystem
> filesystem中规划出一个区块，该区块专门在记录写入或修订文件时的步骤，可以简化一致性检查。
> 	1. 预备：当系统要写入一个文件时，现在日志记录区块中记录某个文件准备要写入的信息；
> 	2. 实际写入：开始写入文件的权限与数据，开始更新metadata的数据；
> 	3. 结束：完成数据与metadata的更新后，在日志记录区块当中完成该文件的记录。


### 4. VFS
> virtual filesystem switch，Linux系统通过VFS管理每个partition商的filesystem。

![[../img/VFS文件系统.png]]

### 5. XFS文件系统
> extended filesystem，主要分为三个部分：
> 	1. 数据区 data section，分为多个存储区群组 allocation groups
> 		1. superblock
> 		2. 剩余空间的管理机制
> 		3. inode的分配与追踪
> 	2. 日志区 log section
> 		1. 记录文件系统的变化，文件的变化现在这里记录，直到该变化完整写入数据区，该记录才会终结。
> 		2. 文件系统损毁时，系统会用这个区块进行检验，以快速修复文件系统。
> 	3. 实时运行区 realtime section
> 		1. 文件要被创建时，将文件放置在这个区块，等到分配完毕，再写入data section的inode与block中去。